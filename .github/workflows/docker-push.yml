name: Build and Push Docker Image

on:
  push:
    branches: [main, master]
    tags: ['*']
  workflow_dispatch:

env:
  IMAGE: ${{ secrets.DOCKER_USERNAME }}/apÃ¬-node

jobs:
  docker:
    runs-on: ubuntu-latest
    steps:
      - name: Check
        uses: actions/checkout@v4

      - name: Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Set Tag
        run: |
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            echo "TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV
          else
            echo "TAG=latest" >> $GITHUB_ENV
          fi

      - name: Build & Push
        uses: docker/build-push-action@v5
        with:
          file: ../../Dockerfile
          push: true
          tags: ${{ env.IMAGE }}:${{ env.TAG }}

      - name: Telegram Message
        run: |
          curl -s \
            -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="Se ha subido una nueva imagen a Docker Hub."
